# 谜题说明

## 谜面

在由五个方块构成的十字形中，每个方块都有一个特定颜色。你可以通过在方块上添加 $\alpha$ 透明度的前景色进行颜色合成，从而改变方块颜色。

请注意：你可以选择十字形的四个边缘方块进行颜色堆叠。无论你选择哪个方块，中心方块都会受到相同的堆叠效果。（因此边缘方块是彼此独立的，而中心方块总会受到它们的影响）

你可以选择的前景色只有 8 种：`#000000` `#FF0000` `#00FF00` `#0000FF` `#00FFFF` `#FF00FF` `#FFFF00` `#FFFFFF`。

你可以将 $\alpha$ 透明度精确到 $0.0001$ 的分度值。

## 参考

可以参考以下程序进行测试，其中 0 代表中心方块，其余四个是边缘方块。

```
cargo r --bin pentasimulator
```

输入的格式为：方块编号（1-4）、颜色名称（或首字母）、$\alpha\times10000$ 的值（整数）。例如，以下输入表示：在方块 2 以 $0.5$ 透明度叠加蓝色。

```
2 b 5000
```

## 题解

> 注：如无特殊说明，下文的所有整数、分数，以及小数的整数部分都采用 16 进制，小数部分都采用 10 进制，例如 $\frac{\mathrm{1f}}{2}=\mathrm{f.5}$。

我们分两部分来解决这个问题：

### 第一部分 边缘颜色的合成

中心方块的颜色受到的影响太多，不方便研究，我们先来考虑最简单的情况：**只给定一个方块，如何合成目标颜色？**

你可以使用 `simulator` 进行单个颜色合成的模拟。

```
cargo r --bin simulator
```

#### 一、1 基本公式和运算符

记一个颜色为向量 $(R,G,B)$，其中每个分量的值域都是 $[00,\mathrm{ff}]$ 范围内的整数。

根据[维基百科](https://en.wikipedia.org/wiki/Alpha_compositing#Description)我们查到，在背景色 $(R_0,G_0,B_0)$ 上叠加 $\alpha$ 透明度的前景色 $(r,g,b)$，得到的新颜色 $(R,G,B)$ 为（当然，如果颜色值域是离散的，那么结果值也会进行舍入）：

$$
(R,G,B)=\alpha(r,g,b)+(1-\alpha)(R_0,G_0,B_0)\tag{1}
$$

为了易于表示，我们定义一个新运算 $\oplus_\alpha$，表示以左操作数为背景色，叠加 $\alpha$ 透明度的右操作数作为前景色。那么上面的公式也可以表示成

$$
(R,G,B)=(R_0,G_0,B_0)\oplus_\alpha(r,g,b)\tag{2}
$$

只可惜运算符 $\oplus_\alpha$ 不满足交换律、结合律、消去律；顶多有个幂等律但也用不上，没什么有趣的性质。

但问题是我们能选择的前景色 $(r,g,b)$ 只有八个预设值，不太可能给定 $(R,G,B)$ 和 $(R_0,G_0,B_0)$ 就让我们找到一个正确的前景色一步解出来。所以我们可能需要的操作会有很多步。

#### 一、2 总和约束

一种自然的想法是：既然八个预设颜色分别提供了不同维度的分量，那我们可以把具有不同维度分量的颜色依次叠加上去，比如：

$$
(R,G,B)=(0,0,0)\oplus_\alpha(\mathrm{ff},00,00)\oplus_\beta(00,\mathrm{ff},00)\oplus_\gamma(00,00,\mathrm{ff})\tag{3}
$$

然后解这个方程组，得到

$$
\begin{cases}
  \alpha=\frac{R}{\mathrm{ff}-B-G}\\
  \beta=\frac{G}{\mathrm{ff}-B}\\
  \gamma=\frac{B}{\mathrm{ff}}
\end{cases}
$$

这种方式看上去很有道理，但你会发现，还有很多颜色无法通过这一系列操作合成（比如 $(80,80,80)$），因为你代入这个式子算出来的 $\alpha,\beta,\gamma$ 根本就不在 $[0,1]$ 这个合理区间内。

如何直观理解 (3) 式存在不可解的颜色？我们不妨定义**一个颜色的模**为 $\|(R,G,B)\|=R+G+B$。于是根据 (1) 式，有

$$
\|(R,G,B)\|=\alpha\|(r,g,b)\|+(1-\alpha)\|(R_0,G_0,B_0)\|\tag{4}
$$

该式表明：$\|(R,G,B)\|$ 相比于 $\|(R_0,G_0,B_0)\|$ 会更趋近于 $\|(r,g,b)\|$。也就是说，在一次合成操作中，**新颜色的模总是会更趋近于前景色**。

于是当我们只使用红、绿、蓝三种颜色（它们的模都是 $\mathrm{ff}$），从黑色（它的模是 $00$）开始进行堆叠的时候，我们只能得到模介于 $[00,\mathrm{ff}]$ 的颜色，而永远不可能构造出 $(80,80,80)$（它的模是 $180$）来。

这个约束意味着，我们不可能只用三种颜色就构造出整个颜色空间，使用八种颜色是进行构造的必要条件。

在第二部分，我们还会接触到这个总和约束的问题。

#### 一、3 舍入逼近

先来思考一个问题：从 $(81,81,00)$ 出发，如何构造 $(81,80,00)$？

如果选择 $(00,00,00)$ 作为前景色，那就存在一个问题：R 分量和 G 分量会同步增长，结果就是 $(81,81,00)\oplus_\alpha(00,00,00)=(80,80,00)$，其中 $\alpha=0.9922$。

而如果选择 $(\mathrm{ff},00,00)$ 作为前景色，我们就需要找到一个 $\alpha$ 使得 $(81,81,00)\oplus_{\alpha}(\mathrm{ff},00,00)=(81,80,00)$，那我们就可以解方程组：

$$
\begin{cases}
\alpha\cdot\mathrm{ff}+(1-\alpha)\cdot81=81\\
\alpha\cdot00+(1-\alpha)\cdot81=80\\
\end{cases}\Rightarrow\begin{cases}
\alpha=0\\
\alpha\approx0.0078
\end{cases}
$$

这个 $\alpha$ 似乎是无解的。但还有一个重要问题被我们从一开始就忽视了：**计算结果的舍入**。

还是以 $(81,81,00)$ 作背景色，我们取 $(\mathrm{ff},00,00)$ 作前景色。我们知道，当 $\alpha=0$ 时，结果是 $(81,81,00)$；当 $\alpha=0.0078$ 时，结果是 $(82,80,00)$；可当 $0<\alpha<0.078$ 时呢？

以 $\alpha=0.0039$ 为例：我们发现

$$
(81,81,00)\oplus_{0.0039}(\mathrm{ff},00,00)=(81.491,80.497,00)
$$

16 比特位的色号无法支持小数，那么在遇到此类情况时，程序会如何处理呢？你实测一下就会发现它最后变成了 $(81,80,00)$，用的是“四舍五入”的规则（更严谨地说是四舍六入）。

如果取 $\alpha=0.0038$ 或者 $\alpha=0.004$，我们就会得到

$$
(81,81,00)\oplus_{0.0038}(\mathrm{ff},00,00)=(81.479,80.51,00)\approx(81,81,00)\\
(81,81,00)\oplus_{0.0040}(\mathrm{ff},00,00)=(81.504,80.484,00)\approx(82,80,00)\\
$$

这个 $\alpha$ 的取值很湊巧，多一点或者少一点都会得不到我们想要的结果；而恰恰是 $0.0039$ 这个值帮我们成功构造出了 $(81,80,00)$。

这个值是通过解以下不等式得到的：

$$
\begin{cases}
\alpha\cdot\mathrm{ff}+(1-\alpha)\cdot81<81.5\\
\alpha\cdot\mathrm{00}+(1-\alpha)\cdot81<80.5\\
\end{cases}\Rightarrow\begin{cases}
\alpha<0.00397\\
\alpha>0.00388
\end{cases}\Rightarrow\alpha=0.0039
$$

**利用结果舍入来逼近我们希望达到的颜色**，是整个谜题的最核心方法。

#### 一、4 逼近操作的分量容忍度

但在正式开始舍入逼近之前，还有一个问题需要考虑。

再来思考一个问题：只用一步操作，可以将 $(81,81,00)$ 变成 $(82,81,00)$ 吗？

使用以上思路进行计算，我们选取 $(\mathrm{ff},\mathrm{ff},00)$ 作为前景色，列出以下不等式：

$$
\begin{cases}
\alpha\cdot\mathrm{ff}+(1-\alpha)\cdot81>81.5\\
\alpha\cdot\mathrm{ff}+(1-\alpha)\cdot81<81.5
\end{cases}
$$

不用往下做，一眼就看得出这个式子它是无解的。

但我们仍可能通过多步操作到达 $(82,81,00)$。我们只需先将 $(81,81,00)$ 变成 $(82,82,00)$，然后再把 $(82,82,00)$ 转化成 $(82,81,00)$ 即可。

$$
(81,81,00)\oplus_{0.0079}(\mathrm{ff},\mathrm{ff},00)\approx(82,82,00)\\
(82,82,00)\oplus_{0.0039}(\mathrm{ff},00,00)\approx(82,81,00)
$$

我们发现，由 $(81,81,00)$ 是无法一步到达 $(82,81,00)$ 的，但由 $(82,82,00)$ 却可以一步到达，它们之间一定存在着某种更重要的差异。

简化起见，现在我们只考虑一个维度的分量，比如 R 分量。我们定义 **R 分量容忍度** $\tau_R$ 和 $\tau_r$，分别表示该分量被高 R 分量值 $\mathrm{ff}$ 和低 R 分量值 $00$ 的前景色覆盖时，能够保持自身颜色不变的最大 $\alpha$ 值。

举个例子，如果某个背景色的 R 分量是 $81$，那么它到 $\mathrm{ff}$ 的容忍度 $\tau_R$ 和到 $00$ 的容忍度 $\tau_r$ 就可以由此求得：

$$
\begin{cases}
\tau_R\cdot\mathrm{ff}+(1-\tau_R)\cdot81=81.5\\
\tau_r\cdot00+(1-\tau_r)\cdot81=80.5
\end{cases}\Rightarrow\begin{cases}
\tau_R\approx0.00397\\
\tau_r\approx0.00388
\end{cases}
$$

这就意味着，只要 $\alpha<\tau_R$，你就可以使用 $\mathrm{ff}$ 而不用担心 R 分量被增大；只要 $\alpha<\tau_r$，你就可以使用 $00$ 而不用担心 R 分量被减小。

进一步，我们可以推导出每个颜色 $(R,G,B)$ 都存在这样六个分量容忍度，它们的公式为：

$$
\begin{cases}
\tau_R=\frac{0.5}{\mathrm{ff}-R}\\
\tau_G=\frac{0.5}{\mathrm{ff}-G}\\
\tau_B=\frac{0.5}{\mathrm{ff}-B}\\
\tau_r=\frac{0.5}{R}\\
\tau_g=\frac{0.5}{G}\\
\tau_b=\frac{0.5}{B}\\
\end{cases}\tag{5}
$$

由这组公式不难看出，**容忍度的大小取决于它到前景色的距离**。比如 $(81,81,00)$，它的六个容忍度分别为

$$
(\tau_R,\tau_G,\tau_B,\tau_r,\tau_g,\tau_b)_{(81,81,00)}=(0.00397,0.00397,0.00196,0.00388,0.00388,\infty)
$$

离 $\mathrm{ff}$ 更近的 $81$，其容忍度更大；而离 $\mathrm{ff}$ 更远的 $00$，其容忍度更小。所以当遇到白色前景色时，只需要 $\alpha=0.0020$ 就可以改变其 B 分量，但要想改变其 R, G 分量则需要 $\alpha=0.0040$ 才行。

再看 $(82,82,00)$，它的六个分量容忍度为

$$
(\tau_R,\tau_G,\tau_B,\tau_r,\tau_g,\tau_b)_{(82,82,00)}=(0.004,0.004,0.00196,0.00385,0.00385,\infty)
$$

因此对于 $(82,82,00)$ 来说，我们只需要以 $(\mathrm{ff},00,00)$ 为前景色取一个小于 $\tau_R$、小于 $\tau_b$ 且大于 $\tau_g$ 的值，使得 R, B 分量不变，而 G 分量能变，这样的 $\alpha$ 就可以满足 $(82,81,00)$ 的要求了。我们的最终选择是 $0.0039$。

#### 一、5 各分量的逼近顺序

真正做过模拟的人一定经受过“好不容易控制好一个分量，却又在调节另一个分量时把它给改了”的绝望感。

由式 (5) 我们得出了一个重要结论，一个分量到它的前景色距离越近，容忍度越高。容忍度高意味着它不容易被改变。

我们希望的就是赶紧把一个分量调对了再去设法调另一个，直到三个分量全调对。我们不希望调着这个分量的时候，那个分量又变了。

所以我们应该**优先固定那些容忍度高的分量**。

举个例子，我们希望由黑色出发，得到 $(10,\mathrm{b0},\mathrm{7f})$。我们发现，R 分量离边界的距离是最近的，那么我们可以先选择白色作为前景色，构造出 $(10,10,10)$。

$$
(00,00,00)\oplus_{0.0627}(\mathrm{ff},\mathrm{ff},\mathrm{ff})=(10,10,10)
$$

接下来我们看到 $\mathrm{b0}$ 到 $\mathrm{ff}$ 的距离要比 $\mathrm{7f}$ 到 $00$ 的距离更近，所以应该再设法固定 G 分量。

我们知道 $(10,10,10)$ 的容忍度为（不用全算出来，算出有用的就行）

$$
(\tau_r,\tau_G)=(0.03125,0.00209)
$$

所以只要选择 $0.00209<\alpha<0.03125$ 然后用 $(00,\mathrm{ff},\mathrm{ff})$ 一步一步逼近 $(10,\mathrm{b0},\mathrm{b0})$ 即可。

最后我们处理 B 分量。我们知道 $(10,\mathrm{b0},\mathrm{b0})$ 的容忍度为

$$
(\tau_r,\tau_g,\tau_B)=(0.03125,0.00284,0.00633)
$$

所以只要选择 $0.00284<\alpha<0.00633$ 然后用 $(00,00,\mathrm{ff})$ 一步一步逼近，就能得到 $(10,\mathrm{b0},\mathrm{7f})$ 了。

### 第二部分 中心颜色的合成

终于搞定了令人厌恶的单个颜色合成，接下来是更加令人厌恶的中心颜色合成。

#### 二、1 方向容忍度

我们在第一部分定义了分量容忍度，它表示的是对于一个分量而言，保持它不增大/减小的最大 $\alpha$ 值。有了这个工具，我们就可以研究如何改变一个分量，同时保持已固定的分量不变。

而现在我们研究的问题变成了：如何改变一个颜色，同时保持另一个颜色不变。

一个颜色有三个分量，每个分量可能增加或减少，总共有 $2^3=8$ 种可能的组合。而本题的八个预选色正好对应了这八种组合，我们可以认为它们是三维颜色空间中八种叠加的方向。当我们选择了某个颜色作为前景色时，我们可以说，背景色会朝着靠近前景色的方向移动。

于是定义一个**方向容忍度**，表示一个颜色对某个方向能保持自身不变的最大 $\alpha$ 值。这个值很容易求得，就是对应分量容忍度的最小值。比如 $(\mathrm{c3},40,\mathrm{ad})$ 的分量容忍度是

$$
(\tau_R,\tau_g,\tau_B)=(0.00833,0.00781,0.00610)
$$

所以它对紫色的方向容忍度为 $\tau_{RgB}=\min(\tau_R,\tau_g,\tau_B)=0.00610$。

倘若这时有另一个颜色，它对紫色的容忍度为 $0.004$ 的话，我们只需选择一个 $0.004<\alpha<0.00610$ 的值，就可以在改变这个颜色的同时，保持那个颜色不变。

回到整个问题。这道题的大方向是很明确的：先达成边缘方块的颜色，再达成中心方块的颜色。原因很简单：但凡你算过中心方块的容忍度，就会发现它并没有任何一个方向的容忍度是很高的，全都非常低（这是我预先设计好的）。既然朝任何方向的容忍度很低，那么即便你一开始通过各种尝试把它的颜色配好，你也会在后续配其它方块的颜色时轻易突破中心方块的容忍度，从而改变其颜色，导致前功尽弃。

而当你配好四个边缘方块的颜色后，你会发现……它们总是存在一两个容忍度较高的方向（这也是我预先设计好的）。因此我们有必要比较四个边缘方块的各方向容忍度，以此确定“对于每个方块来说，往哪些方向的容忍度比中心方块高”。

#### 二、2 必要条件分析

在设计此谜题之初，我进行了大量验证，从而确定了整个问题有解的许多必要条件，并将它们预先设计在规则之内。所以玩家拿到的绝大部分情况都是有解的。接下来我们就必要条件方面做一点分析。

首先是容忍度。我们不必把五个颜色的八个容忍度全算出来，只要做粗略比较就行了。

我们知道，越靠近边界值，容忍度越高。那么 $C_1=(18,\mathrm{f0},\mathrm{e0})$ 相比于 $C_2=(70,80,90)$ 到哪个方向的容忍度最高呢？

因为 $18$ 比 $70$ 更接近 $00$，所以它的 R 分量低方向容忍度 $\tau_r$ 更高；同理，$\mathrm{f0}$ 比 $80$ 更接近 $\mathrm{ff}$，所以它的 G 分量高方向容忍度 $\tau_G$ 更高；$\mathrm{e0}$ 比 $90$ 更接近 $\mathrm{ff}$，所以它的 B 分量高方向容忍度 $\tau_B$ 更高。综上，$C_1$ 相比于 $C_2$，青色 $(00,\mathrm{ff},\mathrm{ff})$ 方向容忍度更高。因此，使用青色作为前景色，可以做到保证 $C_1$ 不变的同时改变 $C_2$。

不难发现，**每个边缘颜色只能为中心颜色提供一个高容忍度方向**。那么四个边缘颜色最多只能提供四个高容忍度方向。如果计算一下你就会发现，这四个方向总是：黑色、黄色、紫色、青色。（我预先设计好的）

可是我们在第一部分提到，出于总和约束的原因，使用八种颜色是进行构造的必要条件；现在只能使用这四个颜色，真的可以构造出我们期望的中心颜色吗？

那我们就来看看中心颜色的模。如果计算一下你就会发现，中心颜色的模总是落在 $[108,\mathrm{1f8}]$ 这个区间内的。（我预先设计好的）

而黑色的模是 $00$，黄、紫、青色的模都是 $\mathrm{1fe}$。从总和约束上看，**由这四个颜色构成区间 $[00,\mathrm{1fe}]$ 内的任何颜色——包括目标颜色都是有可能的**。

#### 二、3 此长彼消问题

当你信信满满地准备按照第一部分中的思路，逐一固定中心颜色的各个分量时，你就会发现问题所在：根本固定不下来。

举个例子：中心颜色是 $(\mathrm{9c},82,92)$，边缘颜色分别是 $\begin{cases}
(68,73,\mathrm{1b})\\
(\mathrm{8f},\mathrm{e9},\mathrm{a5})\\
(\mathrm{de},\mathrm{3d},\mathrm{d1})\\
(\mathrm{c7},\mathrm{d1},\mathrm{2d})
\end{cases}$

假如你已经完成了边缘颜色，且已经构造出了中心颜色 $(\mathrm{9c},80,90)$。下一步，为了增加 G, B 分量，你当然会选择使用 2 次青色（不能使用白色，这样会改变已经调好的边缘颜色）进行构造，可是我们发现：

$$
(\tau_r,\tau_G,\tau_B)_{(\mathrm{9c},80,90)}=(0.00321,0.00394,0.00450)
$$

显然我们不可能在改变 G, B 时不改变 R，因为 R 容忍度太低了。那是否可以退而求其次，多次反复使用紫色和黄色呢？

$$
(\tau_R,\tau_g,\tau_B)_{(\mathrm{9c},80,90)}=(0.00495,0.00385,0.00450)\\
(\tau_R,\tau_G,\tau_b)_{(\mathrm{9c},80,90)}=(0.00495,0.00394,0.00342)
$$

都不行。这也就意味着，无论使用黄、紫、青哪一种颜色，我们都要面对一个“此长彼消”的变化过程。可能是从 $(\mathrm{9c},80,90)$ 变成 $(\mathrm{9b},81,91)$，或者是变成 $(\mathrm{9d},81,\mathrm{8f})$，诸如此类。

而通过这种“此长彼消”的过程，仍然有可能构造出我们的目标颜色，下面是过程：

$$
(\mathrm{9c},80,90)\oplus_{0.0051}(\mathrm{ff},\mathrm{ff},00)\approx(\mathrm{9d},81,\mathrm{8f})\\
(\mathrm{9d},81,\mathrm{8f})\oplus_{0.0052}(\mathrm{ff},00,\mathrm{ff})\approx(\mathrm{9e},80,90)\\
(\mathrm{9e},80,90)\oplus_{0.0046}(00,\mathrm{ff},\mathrm{ff})\approx(\mathrm{9d},81,91)\\
(\mathrm{9d},81,91)\oplus_{0.0046}(00,\mathrm{ff},\mathrm{ff})\approx(\mathrm{9c,82,92})
$$

要解释这个问题，我们需要一点线性代数的知识。我们发现，在 $(9c,82,92)$ 附近较小的邻域内（如果差得太远，那就失效了），这种“此长彼消”会带来的颜色改变量分别是：

- 黄色：$(1,1,-1)$
- 紫色：$(1,-1,1)$
- 青色：$(-1,1,1)$
- 黑色：$(-1,-1,-1)$

这种“改变量”在一定范围内是可以线性组合的。假设我们进行了 $x,y,z,w$ 次黄、紫、青、黑色叠加（顺序无所谓），那么它们对原颜色造成的总改变量 $(\Delta R,\Delta G,\Delta B)$ 可以表达为以下线性方程组：

$$
\begin{cases}
x+y-z-w=\Delta R\\
x-y+z-w=\Delta G\\
-x+y+z-w=\Delta B
\end{cases}
$$

然而这个线性方程组未必有**非负整数解**。接下来我们需要研究一下它在什么情况下有非负整数解；以及如果无解，我们该怎么做。

#### 二、4 改变量的群与格

现在我们暂时跳出“颜色”这个讨论范围，来思考一个新问题：仅由 $(0,0,0)$ 出发，通过 $(1,1,-1),(1,-1,1),(-1,1,1),(-1,-1,-1)$ 四个基本向量进行非负整系数的线性组合，能够形成哪些向量？

它看上去是一个群论问题，我们需要在 $\mathbb{Z}^3$ 这个群（其二元运算符为三维向量加法）内找到上述这组基能形成的集合，我们记为 $L$。我们先来证明 $L$ 是一个群。

- 三维向量加法算符当然是满足结合率的。
- 它有单位元 $(0,0,0)$，也就是我们出发的向量。
- 它的每个元都有逆元……吗？

逆元这个问题并不那么显而易见，所以我们需要仔细论证一下。不难想到，如果上述四个基本向量都有逆元，那么由这些基本向量相加构成的任何元当然都有逆元。所以我们只需要思考如何构造 $(-1,-1,1),(-1,1,-1),(1,-1,-1),(1,1,1)$ 即可。

其实很简单：

$$
\begin{cases}
(-1,-1,1)=(-1,-1,-1)+(-1,1,1)+(1,-1,1)\\
(-1,1,-1)=(-1,-1,-1)+(-1,1,1)+(1,1,-1)\\
(1,-1,-1)=(-1,-1,-1)+(1,-1,1)+(1,1,-1)\\
(1,1,1)=(-1,1,1)+(1,-1,1)+(1,1,-1)
\end{cases}
$$

所以 $L$ 的每个元都有逆元，综上所述，它是一个**群**。

这四个基本向量是线性相关的。如果我们去掉其中的 $(-1,-1,-1)$，它们就是线性无关的。鉴于我们已经构造出了基本向量的相反数，现在我们可以说，系数不再只能是非负整数了，它们可以是任意整数，即 $L$ 的所有元素都可以由 $(1,1,-1),(1,-1,1),(-1,1,1)$ 线性组合得到。因此，$L$ 还是一个**格**，而这三个基本向量构成了格 $L$ 的一个基，我们记为 $B=\left[\begin{matrix}1&1&-1\\1&-1&1\\-1&1&1\end{matrix}\right]$。

$|\det(B)|$ 的大小昭示了格 $L$ 的点密度。因为 $|\det(B)|=4$，所以它的点密度相比于 $\mathbb Z^3$ 只有 $1/4$——换言之，$L$ 只包含了 $\mathbb Z^3$ 中四分之一的点。

所以我们得到结论：**从 $(0,0,0)$ 出发通过四个基本向量能够形成的向量只有 $\mathbb Z^3$ 的四分之一。**

剩下的四分之三向量自然应当从其它点出发，而无论从哪个点出发，能够形成的向量个数都只有 $\mathbb Z^3$ 的四分之一，因此我们还需要找到另外三个彼此不能互推的向量，作为出发点，这样才能达到整个 $\mathbb Z^3$。

若两个向量彼此可以互推，那么它们的差一定在 $L$ 中。现在我们来确定一下 $L$ 有哪些元素。

1. 首先，$(0,0,0)$ 可以达到 $(2,0,0)$，因为 $(1,1,-1)+(1,-1,1)=(2,0,0)$。
2. 一个群内的任意元素的和依然属于这个群。因为 $L$ 是一个群，所以由 $(2,0,0)$ 属于 $L$ 我们推知，对于任意整数 $n$，$(2n,0,0)$ 都是 $L$ 的元素。
3. 同理，$(0,2n,0)$ 及 $(0,0,2n)$ 也都是 $L$ 的元素。
4. 进一步推断， $(2n_1,2n_2,2n_3)$ 也都是 $L$ 的元素。
5. 又因为 $(-1,-1,-1)$ 是 $L$ 的元素，所以 $(2n_1-1,2n_2-1,2n_3-1)$ 也都是 $L$ 的元素。

到这我们已经找完了，再也找不出其它可能，所以我们对 $L$ 的形式化描述就是

$$
L=\{n_1,n_2,n_3\in N|(2n_1,2n_2,2n_3),(2n_1-1,2n_2-1,2n_3-1)\}
$$

于是我们很容易就能想到一些不属于 $L$ 的元素，比如这三个：

$$
(1,0,0),(0,1,0),(0,0,1)
$$

它们不属于 $L$；它们互相作差得到的向量也不在 $L$ 之内，所以彼此不能互推。因而，这三个向量就是我们要找的起点向量，它们可以分别构成以下集合（但这些集合不存在单位元，所以不是群，更不是格）：

$$
L_1=\{n_1,n_2,n_3\in N|(2n_1+1,2n_2,2n_3),(2n_1,2n_2-1,2n_3-1)\}\\
L_2=\{n_1,n_2,n_3\in N|(2n_1,2n_2+1,2n_3),(2n_1-1,2n_2,2n_3-1)\}\\
L_2=\{n_1,n_2,n_3\in N|(2n_1,2n_2,2n_3+1),(2n_1-1,2n_2-1,2n_3)\}
$$

现在我们终于得出了一个新的结论：**由 $(0,0,0),(1,0,0),(0,1,0),(0,0,1)$ 之一出发，通过 $(1,1,-1),(1,-1,1),(-1,1,1),(-1,-1,-1)$ 四个基本向量进行多次叠加，可以形成任意的 $\mathbb Z^3$ 向量**。

#### 二、5 起点判据及其选取

回到之前的线性方程组，不过这次我们写成矩阵形式：

$$
\left[\begin{matrix}
1&1&-1&-1\\
1&-1&1&-1\\
-1&1&1&-1
\end{matrix}\right]\left[\begin{matrix}
x\\y\\z\\w
\end{matrix}\right]=\left[\begin{matrix}
\Delta R\\\Delta G\\\Delta B
\end{matrix}\right]
$$

根据刚才的讨论，我们知道，当 $(\Delta R,\Delta G,\Delta B)\in L$ 时，这个方程组一定有无穷多组非负整数解；反之，这个方程组无解。

如果有解那当然好办，我们算出任意一组合适的 $x,y,z,w$ 然后一点点此长彼消地逼近就行了。如果无解呢？

根据刚才的讨论，任意一个 $\mathbb Z^3$ 向量均可由 $(0,0,0),(1,0,0),(0,1,0),(0,0,1)$ 之一出发经过多次叠加得到。上面这个方程组是从 $(0,0,0)$ 出发的，如果从别的起点出发呢？

比如 $(1,0,0)$：

$$
\left[\begin{matrix}
1\\0\\0
\end{matrix}\right]+\left[\begin{matrix}
1&1&-1&-1\\
1&-1&1&-1\\
-1&1&1&-1
\end{matrix}\right]\left[\begin{matrix}
x\\y\\z\\w
\end{matrix}\right]=\left[\begin{matrix}
\Delta R\\\Delta G\\\Delta B
\end{matrix}\right]
$$

如果它有解，我们解出来就行；如果无解，我们再换其它起点。总之四个起点里总有一个是能让方程有解的。

但我们最坏情况下要拿高斯消元解四遍方程组，未必也太麻烦了。有没有更快一点的方法可以帮我们判断该用哪个起点呢？当然有：**看各分量的奇偶性**。

考察集合 $L$，我们发现，它的元素要么全是偶数 $2n_1,2n_2,2n_3$，要么全是奇数 $2n_1-1,2n_2-1,2n_3-1$，总之奇偶性完全一致。

再考察 $L_1$，我们发现，它的 G, B 分量奇偶性保持一致，而 R 分量与它们相反。同理，$L_2$ 的 G 分量奇偶性与众不同，$L_3$ 的 B 分量奇偶性与众不同。于是当我们拿到任意一个 $\mathbb Z^3$ 时，我们只需要看各分量的奇偶性，就能快速判断它属于哪个集合，进而知道该从哪个起点出发。

现在我们已经能够根据目标改变量找到起点，以及一组可行的“此长彼消”解了。但……这个“起点”意味着什么？我们又真的能如愿到达预想中的起点吗？

举个例子：当前的中心颜色为 $(\mathrm{8d},76,76)$，目标中心颜色是 $(\mathrm{9c},82,92)$，边缘颜色分别是 $\begin{cases}
(68,73,\mathrm{1b})\\
(\mathrm{8f},\mathrm{e9},\mathrm{a5})\\
(\mathrm{de},\mathrm{3d},\mathrm{d1})\\
(\mathrm{c7},\mathrm{d1},\mathrm{2d})
\end{cases}$。

它的目标改变量是 $(\mathrm{0f},\mathrm{0c},\mathrm{0c})$，根据起点判据，它应当使用 $(1,0,0)$ 作为起点。

“起点”意味着我们要先走一步，到达 $(\mathrm{8e},76,76)$，然后再操作后续的此长彼消过程。可是我们计算一下它的各分量容忍度，就会发现：

$$
(\tau_R,\tau_G,\tau_B,\tau_r,\tau_g,\tau_b)_{(\mathrm{8d},76,76)}=(0.00439,0.00365,0.00365,0.00355,0.00424,0.00424)
$$

很遗憾，无论你选择什么颜色作为前景，$\tau_R$ 都是其中容忍度最高的那个。我们不可能在不改变 G, B 分量的情况下就改变 R。所以，我们知道这个起点存在，但我们达不到！

不妨换个思路。我们不一定非要以 $(1,0,0)$ 作为起点，只要取和它在同一个集合的点作为起点，我们一样可以使原方程组有解。

我们就取 $(-1,0,0)$ 吧。因为 $\tau_r$ 的容忍度最低，所以我们使用黑色或青色作为前景色都可行。（但不能使用绿色或蓝色，这样可能导致已固定的边缘颜色发生变化）

就用青色好了：我们先求一下青色方块 $(\mathrm{8f},\mathrm{e9},\mathrm{a5})$ 的青色方向容忍度：

$$
(\tau_r,\tau_G,\tau_B)_{(\mathrm{8f},\mathrm{e9},\mathrm{a5})}=\min(0.00350,0.02273,0.00556)=0.00350
$$

开玩笑的吧，容忍度这么低？

咳，那我们试试黑色吧。很幸运，黑色方块的黑色方向容忍度是 $0.00435$，对我们来说已经够了。我们只需要在 $\begin{cases}0.00355<\alpha<0.00424\\\alpha<0.00435\end{cases}$ 条件下选一个合适的值，就可以把这个问题解决了。

当然如果都不行的话，我们就得尝试别的起点了，比如 $(0,-1,-1)$ 或者类似的。

现在我们已经到达 $(\mathrm{8c},76,76)$，目标改变量是 $(10,\mathrm{0c},\mathrm{0c})$。剩下的就是一步步此长彼消，逐渐逼近 $(\mathrm{9c},82,82)$。这些内容经过我们前面的论证，已经有可行解法，我就不再赘述了。

恭喜，你终于可以通过本关了！
